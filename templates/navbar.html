{% set link_base = "
relative text-sm font-medium transition-colors duration-300
after:absolute after:left-1/2 after:-translate-x-1/2 after:-bottom-1
after:h-[2px] after:w-0 after:bg-blue-500
after:transition-all after:duration-300
hover:after:w-full
" %}

<nav class="bg-gray-900 border-b border-gray-800">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between h-16">

      <!-- Brand -->
      <a href="/"
         class="text-xl font-bold text-white tracking-wide hover:text-blue-400 transition">
        Teacher's Lesson Planner
      </a>

      <!-- Mobile Button -->
      <button class="lg:hidden text-gray-300 hover:text-white"
              onclick="document.getElementById('mobileMenu').classList.toggle('hidden')">
        <i class="bi bi-list text-3xl"></i>
      </button>

      <!-- Desktop -->
      <div class="hidden lg:flex items-center gap-8">

        {% if current_user.is_authenticated %}
        <!-- Main Links -->
        <div class="flex gap-6">

          <a href="/dashboard"
             class="{{ link_base }}
                    {% if active_page == 'dashboard' %}
                      text-white after:w-full
                    {% else %}
                      text-gray-300 hover:text-white
                    {% endif %}">
            {% if language == 'ar' %}لوحة التحكم{% else %}Dashboard{% endif %}
          </a>

          <a href="/lessons"
             class="{{ link_base }}
                    {% if active_page == 'lessons' %}
                      text-white after:w-full
                    {% else %}
                      text-gray-300 hover:text-white
                    {% endif %}">
            {% if language == 'ar' %}دروسي{% else %}My Lessons{% endif %}
          </a>

          <a href="/create-lesson"
             class="{{ link_base }}
                    {% if active_page == 'create' %}
                      text-white after:w-full
                    {% else %}
                      text-gray-300 hover:text-white
                    {% endif %}">
            {% if language == 'ar' %}إنشاء درس{% else %}Create Lesson{% endif %}
          </a>

          <a href="/whatsapp-sender"
             class="{{ link_base }}
                    {% if active_page == 'whatsapp' %}
                      text-white after:w-full
                    {% else %}
                      text-gray-300 hover:text-white
                    {% endif %}">
            {% if language == 'ar' %}واتساب{% else %}WhatsApp{% endif %}
          </a>

        </div>

        <!-- User -->
        <div class="flex items-center gap-4 pl-6 border-l border-gray-700">
          <a href="/user" class="text-gray-300 hover:text-white text-sm">
            {{ current_user.name }}
          </a>
          {% if current_user.is_authenticated and current_user.token_balance is not none %}
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs
                         bg-indigo-700/30 text-indigo-300 border border-indigo-600">
              <i class="bi bi-coin mr-1"></i>
              {{ current_user.token_balance }}
            </span>
          </div>
          {% endif %}

          <a href="{{ url_for('routes.logout') }}"
             class="px-4 py-2 text-sm border border-blue-600 text-blue-400 rounded-lg
                    hover:bg-blue-600 hover:text-white transition">
            {% if language == 'ar' %}خروج{% else %}Logout{% endif %}
          </a>
        </div>

        {% else %}
        <!-- Guest -->
        <a href="/login"
           class="{{ link_base }}
                  {% if active_page == 'login' %}
                    text-white after:w-full
                  {% else %}
                    text-gray-300 hover:text-white
                  {% endif %}">
          {% if language == 'ar' %}تسجيل الدخول{% else %}Login{% endif %}
        </a>

        <a href="/register"
           class="{{ link_base }}
                  {% if active_page == 'register' %}
                    text-white after:w-full
                  {% else %}
                    text-gray-300 hover:text-white
                  {% endif %}">
          {% if language == 'ar' %}التسجيل{% else %}Register{% endif %}
        </a>
        {% endif %}

        <!-- Language Dropdown -->
        <div class="relative">
          <button onclick="toggleLanguageDropdown()"
                  class="text-gray-300 hover:text-white flex items-center gap-1 text-sm">
            <i class="bi bi-globe"></i>
            {{ 'العربية' if language == 'ar' else 'English' }}
            <i class="bi bi-chevron-down text-xs transition-transform" id="langChevron"></i>
          </button>

          <div id="languageDropdown"
               class="absolute right-0 mt-3 w-36 bg-gray-900 border border-gray-700
                      rounded-lg shadow-lg opacity-0 invisible
                      transition-all duration-200 transform origin-top scale-95">
            <a href="{{ url_for('routes.set_language', language='en') }}"
               class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 
                      hover:text-white rounded-t-lg transition">
              English
            </a>
            <a href="{{ url_for('routes.set_language', language='ar') }}"
               class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 
                      hover:text-white rounded-b-lg transition">
              العربية
            </a>
          </div>
        </div>

      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu"
         class="hidden lg:hidden mt-4 bg-gray-900 rounded-xl
                border border-gray-800 p-4 space-y-3">

      {% if current_user.is_authenticated %}
        <a href="/dashboard" class="block px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
          {% if language == 'ar' %}لوحة التحكم{% else %}Dashboard{% endif %}
        </a>
        <a href="/lessons" class="block px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
          {% if language == 'ar' %}دروسي{% else %}My Lessons{% endif %}
        </a>
        <a href="/create-lesson" class="block px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
          {% if language == 'ar' %}إنشاء درس{% else %}Create Lesson{% endif %}
        </a>
        <a href="/whatsapp-sender" class="block px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
          {% if language == 'ar' %}واتساب{% else %}WhatsApp{% endif %}
        </a>

        <div class="pt-2 border-t border-gray-700">
          <button onclick="toggleMobileLanguageDropdown()"
                  class="w-full text-left px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800 flex items-center justify-between">
            <span>
              <i class="bi bi-globe"></i>
              {{ 'العربية' if language == 'ar' else 'English' }}
            </span>
            <i class="bi bi-chevron-down text-xs transition-transform" id="mobileLangChevron"></i>
          </button>
          
          <div id="mobileLanguageDropdown" class="hidden mt-2 ml-4 space-y-2">
            <a href="{{ url_for('routes.set_language', language='en') }}"
               class="block px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-gray-800">
              English
            </a>
            <a href="{{ url_for('routes.set_language', language='ar') }}"
               class="block px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-gray-800">
              العربية
            </a>
          </div>
        </div>
        
        {% if current_user.is_authenticated and current_user.token_balance is not none %}
        <div class="flex items-center gap-2 mt-2 px-4">
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs
                       bg-indigo-700/30 text-indigo-300 border border-indigo-600">
            <i class="bi bi-coin mr-1"></i>
            {{ current_user.token_balance }}
          </span>
        </div>
        {% endif %}

        <a href="{{ url_for('routes.logout') }}"
           class="block text-center px-4 py-2 mt-2
                  border border-blue-600 text-blue-400 rounded-lg
                  hover:bg-blue-600 hover:text-white transition">
          {% if language == 'ar' %}خروج{% else %}Logout{% endif %}
        </a>
      {% else %}
        <a href="/login" class="block px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
          {% if language == 'ar' %}تسجيل الدخول{% else %}Login{% endif %}
        </a>
        <a href="/register" class="block px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800">
          {% if language == 'ar' %}التسجيل{% else %}Register{% endif %}
        </a>

        <div class="pt-2 border-t border-gray-700">
          <button onclick="toggleMobileLanguageDropdown()"
                  class="w-full text-left px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-800 flex items-center justify-between">
            <span>
              <i class="bi bi-globe"></i>
              {{ 'العربية' if language == 'ar' else 'English' }}
            </span>
            <i class="bi bi-chevron-down text-xs transition-transform" id="mobileLangChevron"></i>
          </button>
          
          <div id="mobileLanguageDropdown" class="hidden mt-2 ml-4 space-y-2">
            <a href="{{ url_for('routes.set_language', language='en') }}"
               class="block px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-gray-800">
              English
            </a>
            <a href="{{ url_for('routes.set_language', language='ar') }}"
               class="block px-4 py-2 rounded-lg text-sm text-gray-400 hover:bg-gray-800">
              العربية
            </a>
          </div>
        </div>
      {% endif %}
    </div>

  </div>
</nav>

<script>
// Desktop Language Dropdown
function toggleLanguageDropdown() {
  const dropdown = document.getElementById('languageDropdown');
  const chevron = document.getElementById('langChevron');
  
  if (dropdown.classList.contains('opacity-0')) {
    dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
    dropdown.classList.add('opacity-100', 'visible', 'scale-100');
    chevron.style.transform = 'rotate(180deg)';
  } else {
    dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
    dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
    chevron.style.transform = 'rotate(0deg)';
  }
}

// Mobile Language Dropdown
function toggleMobileLanguageDropdown() {
  const dropdown = document.getElementById('mobileLanguageDropdown');
  const chevron = document.getElementById('mobileLangChevron');
  
  dropdown.classList.toggle('hidden');
  
  if (dropdown.classList.contains('hidden')) {
    chevron.style.transform = 'rotate(0deg)';
  } else {
    chevron.style.transform = 'rotate(180deg)';
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('languageDropdown');
  const chevron = document.getElementById('langChevron');
  const button = event.target.closest('button[onclick="toggleLanguageDropdown()"]');
  
  if (!button && !dropdown.contains(event.target)) {
    dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
    dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
    if (chevron) chevron.style.transform = 'rotate(0deg)';
  }
});
</script>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher's Lesson Planner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        .lesson-content h1 {
            font-size: 2em;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .lesson-content h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .lesson-content h3 {
            font-size: 1.25em;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .lesson-content p {
            margin-bottom: 0.5rem;
        }
        .lesson-content ul, .lesson-content ol {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .lesson-content strong {
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="app"></div>
    
    <!-- React Development Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- React Components -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { BrowserRouter, Routes, Route, Link, useNavigate, useParams } = ReactRouterDOM;

        // Navigation Component
        const Navigation = ({ user, onLogout }) => {
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            return (
                <nav className="bg-gray-800 border-b border-gray-700">
                    <div className="container mx-auto px-4">
                        <div className="flex items-center justify-between py-3">
                            <Link to="/" className="text-xl font-bold text-white hover:text-gray-300 transition">
                                Teacher's Lesson Planner
                            </Link>
                            
                            <button 
                                className="lg:hidden text-gray-300 hover:text-white"
                                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                            >
                                <i className="bi bi-list text-2xl"></i>
                            </button>
                            
                            <div className="hidden lg:flex lg:items-center lg:space-x-6">
                                {user ? (
                                    <>
                                        <Link to="/dashboard" className="text-gray-300 hover:text-white transition">
                                            Dashboard
                                        </Link>
                                        <Link to="/lessons" className="text-gray-300 hover:text-white transition">
                                            My Lessons
                                        </Link>
                                        <Link to="/lessons/new" className="text-gray-300 hover:text-white transition">
                                            Create New Lesson
                                        </Link>
                                        <span className="text-gray-300">{user.name}</span>
                                        <button 
                                            onClick={onLogout}
                                            className="px-4 py-2 border border-gray-300 text-gray-300 rounded-lg hover:bg-gray-700 hover:text-white transition"
                                        >
                                            Logout
                                        </button>
                                    </>
                                ) : (
                                    <Link to="/login" className="text-gray-300 hover:text-white transition">
                                        Login / Register
                                    </Link>
                                )}
                            </div>
                        </div>
                        
                        {mobileMenuOpen && (
                            <div className="lg:hidden pb-4">
                                <div className="flex flex-col space-y-3">
                                    {user ? (
                                        <>
                                            <Link to="/dashboard" className="text-gray-300 hover:text-white transition">
                                                Dashboard
                                            </Link>
                                            <Link to="/lessons" className="text-gray-300 hover:text-white transition">
                                                My Lessons
                                            </Link>
                                            <Link to="/lessons/new" className="text-gray-300 hover:text-white transition">
                                                Create New Lesson
                                            </Link>
                                            <span className="text-gray-300">{user.name}</span>
                                            <button 
                                                onClick={onLogout}
                                                className="px-4 py-2 border border-gray-300 text-gray-300 rounded-lg hover:bg-gray-700 hover:text-white transition text-center"
                                            >
                                                Logout
                                            </button>
                                        </>
                                    ) : (
                                        <Link to="/login" className="text-gray-300 hover:text-white transition">
                                            Login / Register
                                        </Link>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </nav>
            );
        };

        // Auth Component (Login/Register)
        const Auth = ({ onLogin, onRegister }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({
                name: '',
                email: '',
                password: '',
                confirmPassword: ''
            });
            const [errors, setErrors] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };

            const validateForm = () => {
                const newErrors = {};
                
                if (isLogin) {
                    if (!formData.email) newErrors.email = 'Email is required';
                    if (!formData.password) newErrors.password = 'Password is required';
                } else {
                    if (!formData.name) newErrors.name = 'Name is required';
                    if (!formData.email) newErrors.email = 'Email is required';
                    if (!formData.password) newErrors.password = 'Password is required';
                    if (formData.password.length < 6) newErrors.password = 'Password must be at least 6 characters';
                    if (formData.password !== formData.confirmPassword) newErrors.confirmPassword = 'Passwords do not match';
                }
                
                return newErrors;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                const formErrors = validateForm();
                if (Object.keys(formErrors).length > 0) {
                    setErrors(formErrors);
                    return;
                }
                
                setIsSubmitting(true);
                setErrors({});
                
                try {
                    if (isLogin) {
                        const success = await onLogin({
                            email: formData.email,
                            password: formData.password
                        });
                        
                        if (!success) {
                            setErrors({ general: 'Invalid email or password' });
                        }
                    } else {
                        const success = await onRegister({
                            name: formData.name,
                            email: formData.email,
                            password: formData.password
                        });
                        
                        if (success) {
                            setIsLogin(true);
                            setFormData({
                                ...formData,
                                name: '',
                                password: '',
                                confirmPassword: ''
                            });
                        }
                    }
                } catch (error) {
                    setErrors({ general: error.message });
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="flex justify-center">
                    <div className="w-full max-w-md">
                        <div className="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                            <div className="bg-indigo-600 rounded-t-lg p-4">
                                <div className="flex space-x-2">
                                    <button 
                                        className={`flex-1 py-2 px-4 rounded ${isLogin ? 'bg-white text-indigo-600' : 'text-white hover:bg-indigo-700'} transition`}
                                        onClick={() => setIsLogin(true)}
                                    >
                                        Login
                                    </button>
                                    <button 
                                        className={`flex-1 py-2 px-4 rounded ${!isLogin ? 'bg-white text-indigo-600' : 'text-white hover:bg-indigo-700'} transition`}
                                        onClick={() => setIsLogin(false)}
                                    >
                                        Register
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-6">
                                {errors.general && (
                                    <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded mb-4">
                                        {errors.general}
                                    </div>
                                )}
                                
                                <form onSubmit={handleSubmit}>
                                    {!isLogin && (
                                        <div className="mb-4">
                                            <label htmlFor="name" className="block text-sm font-semibold text-gray-200 mb-2">
                                                Name
                                            </label>
                                            <input
                                                type="text"
                                                className={`w-full bg-gray-700 border ${errors.name ? 'border-red-500' : 'border-gray-600'} text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500`}
                                                id="name"
                                                name="name"
                                                value={formData.name}
                                                onChange={handleChange}
                                            />
                                            {errors.name && <p className="text-red-400 text-sm mt-1">{errors.name}</p>}
                                        </div>
                                    )}
                                    
                                    <div className="mb-4">
                                        <label htmlFor="email" className="block text-sm font-semibold text-gray-200 mb-2">
                                            Email
                                        </label>
                                        <input
                                            type="email"
                                            className={`w-full bg-gray-700 border ${errors.email ? 'border-red-500' : 'border-gray-600'} text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500`}
                                            id="email"
                                            name="email"
                                            value={formData.email}
                                            onChange={handleChange}
                                        />
                                        {errors.email && <p className="text-red-400 text-sm mt-1">{errors.email}</p>}
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label htmlFor="password" className="block text-sm font-semibold text-gray-200 mb-2">
                                            Password
                                        </label>
                                        <input
                                            type="password"
                                            className={`w-full bg-gray-700 border ${errors.password ? 'border-red-500' : 'border-gray-600'} text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500`}
                                            id="password"
                                            name="password"
                                            value={formData.password}
                                            onChange={handleChange}
                                        />
                                        {errors.password && <p className="text-red-400 text-sm mt-1">{errors.password}</p>}
                                    </div>
                                    
                                    {!isLogin && (
                                        <div className="mb-4">
                                            <label htmlFor="confirmPassword" className="block text-sm font-semibold text-gray-200 mb-2">
                                                Confirm Password
                                            </label>
                                            <input
                                                type="password"
                                                className={`w-full bg-gray-700 border ${errors.confirmPassword ? 'border-red-500' : 'border-gray-600'} text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500`}
                                                id="confirmPassword"
                                                name="confirmPassword"
                                                value={formData.confirmPassword}
                                                onChange={handleChange}
                                            />
                                            {errors.confirmPassword && <p className="text-red-400 text-sm mt-1">{errors.confirmPassword}</p>}
                                        </div>
                                    )}
                                    
                                    <button 
                                        type="submit" 
                                        className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg transition disabled:opacity-50"
                                        disabled={isSubmitting}
                                    >
                                        {isSubmitting ? (
                                            <>
                                                <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                                                {isLogin ? 'Logging in...' : 'Registering...'}
                                            </>
                                        ) : (
                                            isLogin ? 'Login' : 'Register'
                                        )}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Dashboard Component
        const Dashboard = ({ user }) => {
            const [stats, setStats] = useState({
                totalLessons: 0,
                recentLessons: []
            });
            const [loading, setLoading] = useState(true);
            const navigate = useNavigate();
            
            useEffect(() => {
                const fetchStats = async () => {
                    try {
                        const response = await axios.get('/api/lessons');
                        setStats({
                            totalLessons: response.data.length,
                            recentLessons: response.data.slice(0, 5)
                        });
                    } catch (error) {
                        console.error('Error fetching dashboard data:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                
                fetchStats();
            }, []);
            
            if (loading) {
                return (
                    <div className="flex justify-center py-12">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    </div>
                );
            }
            
            return (
                <div>
                    <h2 className="text-3xl font-bold text-white mb-8">Welcome, {user.name}!</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-indigo-600 rounded-lg p-8 text-white">
                            <h3 className="text-5xl font-bold mb-2">{stats.totalLessons}</h3>
                            <p className="text-xl">Total Lessons Created</p>
                        </div>
                        
                        <div className="bg-gray-800 border border-gray-700 rounded-lg p-8">
                            <i className="bi bi-file-earmark-text text-5xl text-indigo-400 mb-4"></i>
                            <p className="text-lg text-gray-300 mb-4">Create New Lesson Plan</p>
                            <button 
                                className="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition"
                                onClick={() => navigate('/lessons/new')}
                            >
                                Start New Lesson
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                        <div className="px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                            <h5 className="text-xl font-bold text-white">Recent Lessons</h5>
                            <button 
                                className="text-sm border border-indigo-600 text-indigo-400 hover:bg-indigo-600 hover:text-white py-2 px-4 rounded-lg transition"
                                onClick={() => navigate('/lessons')}
                            >
                                View All
                            </button>
                        </div>
                        
                        <div className="p-6">
                            {stats.recentLessons.length > 0 ? (
                                <div className="space-y-3">
                                    {stats.recentLessons.map(lesson => (
                                        <div key={lesson.id} className="flex justify-between items-center p-4 bg-gray-700 rounded-lg">
                                            <div>
                                                <h6 className="font-semibold text-white mb-1">{lesson.topic}</h6>
                                                <small className="text-gray-400">
                                                    Grade: {lesson.grade_level} | Strategy: {lesson.teaching_strategy.replace('_', ' ')}
                                                </small>
                                            </div>
                                            <button 
                                                className="border border-indigo-600 text-indigo-400 hover:bg-indigo-600 hover:text-white py-2 px-4 rounded-lg transition text-sm"
                                                onClick={() => navigate(`/lessons/${lesson.id}`)}
                                            >
                                                View
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-8">
                                    <p className="text-gray-400 mb-4">No lessons created yet.</p>
                                    <button 
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition"
                                        onClick={() => navigate('/lessons/new')}
                                    >
                                        Create Your First Lesson
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // LessonForm Component
        const LessonForm = ({ user }) => {
            const [formData, setFormData] = useState({
                grade_level: 'K',
                topic: '',
                teaching_strategy: 'direct_instruction'
            });
            const [errors, setErrors] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);
            const navigate = useNavigate();
            
            const gradeOptions = [
                { value: 'K', label: 'Kindergarten' },
                { value: '1', label: '1st Grade' },
                { value: '2', label: '2nd Grade' },
                { value: '3', label: '3rd Grade' },
                { value: '4', label: '4th Grade' },
                { value: '5', label: '5th Grade' },
                { value: '6', label: '6th Grade' },
                { value: '7', label: '7th Grade' },
                { value: '8', label: '8th Grade' },
                { value: '9', label: '9th Grade' },
                { value: '10', label: '10th Grade' },
                { value: '11', label: '11th Grade' },
                { value: '12', label: '12th Grade' }
            ];
            
            const strategyOptions = [
                { value: 'cooperative_learning', label: 'Cooperative Learning' },
                { value: 'brainstorming', label: 'Brainstorming' },
                { value: 'discovery_learning', label: 'Discovery Learning' },
                { value: 'direct_instruction', label: 'Direct Instruction' },
                { value: 'project_based', label: 'Project-Based Learning' },
                { value: 'flipped_classroom', label: 'Flipped Classroom' },
                { value: 'inquiry_based', label: 'Inquiry-Based Learning' },
                { value: 'differentiated_instruction', label: 'Differentiated Instruction' },
                { value: 'game_based', label: 'Game-Based Learning' }
            ];
            
            const handleChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };
            
            const validateForm = () => {
                const newErrors = {};
                
                if (!formData.topic) newErrors.topic = 'Lesson topic is required';
                if (formData.topic && formData.topic.length < 3) newErrors.topic = 'Topic must be at least 3 characters';
                
                return newErrors;
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                
                const formErrors = validateForm();
                if (Object.keys(formErrors).length > 0) {
                    setErrors(formErrors);
                    return;
                }
                
                setIsSubmitting(true);
                setErrors({});
                
                try {
                    await axios.post('/api/attendance/confirm', { amount: 1, reason: 'lesson_create' });
                    await axios.post('/api/lessons', formData);
                    navigate('/lessons');
                } catch (error) {
                    setErrors({ general: error.response?.data?.message || 'Failed to create lesson' });
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            return (
                <div>
                    <h2 className="text-3xl font-bold text-white mb-8">Create New Lesson Plan</h2>
                    
                    <div className="bg-gray-800 rounded-lg shadow-lg border border-gray-700 p-8">
                        {errors.general && (
                            <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded mb-6">
                                {errors.general}
                            </div>
                        )}
                        
                        <form onSubmit={handleSubmit}>
                            <div className="mb-6">
                                <label htmlFor="grade_level" className="block text-sm font-semibold text-gray-200 mb-2">
                                    Grade Level
                                </label>
                                <select
                                    className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    id="grade_level"
                                    name="grade_level"
                                    value={formData.grade_level}
                                    onChange={handleChange}
                                >
                                    {gradeOptions.map(option => (
                                        <option key={option.value} value={option.value}>
                                            {option.label}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="mb-6">
                                <label htmlFor="topic" className="block text-sm font-semibold text-gray-200 mb-2">
                                    Lesson Topic
                                </label>
                                <input
                                    type="text"
                                    className={`w-full bg-gray-700 border ${errors.topic ? 'border-red-500' : 'border-gray-600'} text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500`}
                                    id="topic"
                                    name="topic"
                                    value={formData.topic}
                                    onChange={handleChange}
                                    placeholder="e.g., Photosynthesis, Addition with Regrouping, World War II"
                                />
                                {errors.topic && <p className="text-red-400 text-sm mt-1">{errors.topic}</p>}
                            </div>
                            
                            <div className="mb-6">
                                <label htmlFor="teaching_strategy" className="block text-sm font-semibold text-gray-200 mb-2">
                                    Teaching Strategy
                                </label>
                                <select
                                    className="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    id="teaching_strategy"
                                    name="teaching_strategy"
                                    value={formData.teaching_strategy}
                                    onChange={handleChange}
                                >
                                    {strategyOptions.map(option => (
                                        <option key={option.value} value={option.value}>
                                            {option.label}
                                        </option>
                                    ))}
                                </select>
                                <p className="text-gray-400 text-sm mt-2">
                                    The teaching strategy will influence how the lesson plan is structured.
                                </p>
                            </div>
                            
                            <div className="flex justify-between gap-3">
                                <button 
                                    type="button" 
                                    className="bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-8 rounded-lg transition"
                                    onClick={() => navigate('/lessons')}
                                >
                                    Cancel
                                </button>
                                <button 
                                    type="submit" 
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-8 rounded-lg transition disabled:opacity-50"
                                    disabled={isSubmitting}
                                >
                                    {isSubmitting ? (
                                        <>
                                            <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                                            Generating...
                                        </>
                                    ) : (
                                        'Generate Lesson Plan'
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // LessonList Component
        const LessonList = () => {
            const [lessons, setLessons] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const navigate = useNavigate();
            
            useEffect(() => {
                const fetchLessons = async () => {
                    try {
                        const response = await axios.get('/api/lessons');
                        setLessons(response.data);
                    } catch (err) {
                        setError('Failed to load lessons');
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };
                
                fetchLessons();
            }, []);
            
            const handleDelete = async (id) => {
                if (window.confirm('Are you sure you want to delete this lesson plan?')) {
                    try {
                        await axios.delete(`/api/lessons/${id}`);
                        setLessons(lessons.filter(lesson => lesson.id !== id));
                    } catch (err) {
                        setError('Failed to delete lesson');
                        console.error(err);
                    }
                }
            };
            
            if (loading) {
                return (
                    <div className="flex justify-center py-12">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    </div>
                );
            }
            
            return (
                <div>
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-3xl font-bold text-white">My Lesson Plans</h2>
                        <button 
                            className="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg transition inline-flex items-center"
                            onClick={() => navigate('/lessons/new')}
                        >
                            <i className="bi bi-plus-circle mr-2"></i> New Lesson Plan
                        </button>
                    </div>
                    
                    {error && (
                        <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded mb-6">
                            {error}
                        </div>
                    )}
                    
                    {lessons.length === 0 ? (
                        <div className="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                            <div className="p-12 text-center">
                                <h5 className="text-2xl font-bold text-white mb-3">No Lesson Plans Yet</h5>
                                <p className="text-gray-400 mb-6">Create your first lesson plan to get started.</p>
                                <button 
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-8 rounded-lg transition"
                                    onClick={() => navigate('/lessons/new')}
                                >
                                    Create First Lesson Plan
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-gray-800 rounded-lg shadow-lg border border-gray-700 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-700">
                                        <tr>
                                            <th className="px-6 py-4 text-left text-gray-300 font-semibold">Topic</th>
                                            <th className="px-6 py-4 text-left text-gray-300 font-semibold">Grade</th>
                                            <th className="px-6 py-4 text-left text-gray-300 font-semibold">Strategy</th>
                                            <th className="px-6 py-4 text-left text-gray-300 font-semibold">Date Created</th>
                                            <th className="px-6 py-4 text-left text-gray-300 font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {lessons.map(lesson => (
                                            <tr key={lesson.id} className="border-t border-gray-700 hover:bg-gray-750 transition">
                                                <td className="px-6 py-4 text-white">{lesson.topic}</td>
                                                <td className="px-6 py-4 text-gray-300">{lesson.grade_level}</td>
                                                <td className="px-6 py-4 text-gray-300">{lesson.teaching_strategy.replace('_', ' ')}</td>
                                                <td className="px-6 py-4 text-gray-300">{new Date(lesson.date_created).toLocaleDateString()}</td>
                                                <td className="px-6 py-4">
                                                    <div className="flex space-x-2">
                                                        <button 
                                                            className="border border-indigo-600 text-indigo-400 hover:bg-indigo-600 hover:text-white py-1 px-3 rounded transition"
                                                            onClick={() => navigate(`/lessons/${lesson.id}`)}
                                                        >
                                                            <i className="bi bi-eye"></i>
                                                        </button>
                                                        <button 
                                                            className="border border-gray-600 text-gray-400 hover:bg-gray-600 hover:text-white py-1 px-3 rounded transition"
                                                            onClick={() => navigate(`/lessons/${lesson.id}/edit`)}
                                                        >
                                                            <i className="bi bi-pencil"></i>
                                                        </button>
                                                        <button 
                                                            className="border border-red-600 text-red-400 hover:bg-red-600 hover:text-white py-1 px-3 rounded transition"
                                                            onClick={() => handleDelete(lesson.id)}
                                                        >
                                                            <i className="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // LessonView Component
        const LessonView = () => {
            const [lesson, setLesson] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isGeneratingPresentation, setIsGeneratingPresentation] = useState(false);
            const [presentationId, setPresentationId] = useState(null);
            const { id } = useParams();
            const navigate = useNavigate();
            
            useEffect(() => {
                const fetchLesson = async () => {
                    try {
                        const response = await axios.get(`/api/lessons/${id}`);
                        setLesson(response.data);
                    } catch (err) {
                        setError('Failed to load lesson');
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };
                
                fetchLesson();
            }, [id]);
            
            const handleGeneratePresentation = async () => {
                setIsGeneratingPresentation(true);
                try {
                    const response = await axios.post(`/api/lessons/${id}/presentation`);
                    setPresentationId(response.data.presentation_id);
                } catch (err) {
                    setError('Failed to generate presentation');
                    console.error(err);
                } finally {
                    setIsGeneratingPresentation(false);
                }
            };
            
            const handleEdit = () => {
                navigate(`/lessons/${id}/edit`);
            };
            
            const handleDownloadPresentation = () => {
                window.location.href = `/api/presentations/${presentationId}/download`;
            };
            
            if (loading) {
                return (
                    <div className="flex justify-center py-12">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    </div>
                );
            }
            
            if (error) {
                return (
                    <div className="bg-red-500/20 border border-red-500 text-red-200 px-4 py-3 rounded">
                        {error}
                    </div>
                );
            }
            
            if (!lesson) {
                return (
                    <div className="bg-yellow-500/20 border border-yellow-500 text-yellow-200 px-4 py-3 rounded">
                        Lesson not found
                    </div>
                );
            }
            
            return (
                <div>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                        <h2 className="text-3xl font-bold text-white">{lesson.topic}</h2>
                        <div className="flex gap-2">
                            <button 
                                className="border-2 border-indigo-600 text-indigo-400 hover:bg-indigo-600 hover:text-white font-medium py-2 px-6 rounded-lg transition inline-flex items-center"
                                onClick={handleEdit}
                            >
                                <i className="bi bi-pencil mr-2"></i> Edit
                            </button>
                            {presentationId ? (
                                <button 
                                    className="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-lg transition inline-flex items-center"
                                    onClick={handleDownloadPresentation}
                                >
                                    <i className="bi bi-download mr-2"></i> Download Presentation
                                </button>
                            ) : (
                                <button 
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-lg transition inline-flex items-center disabled:opacity-50"
                                    onClick={handleGeneratePresentation}
                                    disabled={isGeneratingPresentation}
                                >
                                    {isGeneratingPresentation ? (
                                        <>
                                            <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                                            Generating...
                                        </>
                                    ) : (
                                        <>
                                            <i className="bi bi-file-earmark-slides mr-2"></i> Generate Presentation
                                        </>
                                    )}
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div className="bg-gray-800 rounded-lg shadow-lg border border-gray-700 mb-6">
                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <span className="text-gray-400 font-semibold">Grade Level:</span>
                                    <span className="text-white ml-2">{lesson.grade_level}</span>
                                </div>
                                <div>
                                    <span className="text-gray-400 font-semibold">Teaching Strategy:</span>
                                    <span className="text-white ml-2">{lesson.teaching_strategy.replace('_', ' ')}</span>
                                </div>
                                <div>
                                    <span className="text-gray-400 font-semibold">Date Created:</span>
                                    <span className="text-white ml-2">{new Date(lesson.date_created).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-gray-800 rounded-lg shadow-lg border border-gray-700">
                        <div className="px-6 py-4 border-b border-gray-700">
                            <h5 className="text-xl font-bold text-white">Lesson Plan</h5>
                        </div>
                        <div className="p-6">
                            <div 
                                className="lesson-content prose prose-invert max-w-none"
                                dangerouslySetInnerHTML={{ __html: marked.parse(lesson.generated_plan) }}
                            ></div>
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);
            
            useEffect(() => {
                // Check if user is logged in on mount
                const checkAuth = async () => {
                    try {
                        const response = await axios.get('/api/auth/check');
                        setUser(response.data.user);
                    } catch (err) {
                        // Not logged in
                    }
                };
                
                checkAuth();
            }, []);
            
            const handleLogin = async (credentials) => {
                try {
                    const response = await axios.post('/api/auth/login', credentials);
                    setUser(response.data.user);
                    return true;
                } catch (err) {
                    return false;
                }
            };
            
            const handleRegister = async (userData) => {
                try {
                    await axios.post('/api/auth/register', userData);
                    return true;
                } catch (err) {
                    return false;
                }
            };
            
            const handleLogout = async () => {
                try {
                    await axios.post('/api/auth/logout');
                    setUser(null);
                } catch (err) {
                    console.error('Logout error:', err);
                }
            };
            
            return (
                <BrowserRouter>
                    <div className="min-h-screen flex flex-col">
                        <Navigation user={user} onLogout={handleLogout} />
                        
                        <main className="flex-grow container mx-auto px-4 py-8">
                            <Routes>
                                <Route path="/" element={
                                    user ? <Dashboard user={user} /> : <Auth onLogin={handleLogin} onRegister={handleRegister} />
                                } />
                                <Route path="/login" element={<Auth onLogin={handleLogin} onRegister={handleRegister} />} />
                                <Route path="/dashboard" element={user ? <Dashboard user={user} /> : <Auth onLogin={handleLogin} onRegister={handleRegister} />} />
                                <Route path="/lessons" element={user ? <LessonList /> : <Auth onLogin={handleLogin} onRegister={handleRegister} />} />
                                <Route path="/lessons/new" element={user ? <LessonForm user={user} /> : <Auth onLogin={handleLogin} onRegister={handleRegister} />} />
                                <Route path="/lessons/:id" element={user ? <LessonView /> : <Auth onLogin={handleLogin} onRegister={handleRegister} />} />
                                <Route path="/lessons/:id/edit" element={user ? <LessonForm user={user} /> : <Auth onLogin={handleLogin} onRegister={handleRegister} />} />
                            </Routes>
                        </main>
                        
                        <footer className="bg-gray-800 text-gray-300 py-8 mt-12 border-t border-gray-700">
                            <div className="container mx-auto px-4 text-center">
                                <p className="text-gray-400"> 2025 Teacher's Lesson Planner. All rights reserved.</p>
                            </div>
                        </footer>
                    </div>
                </BrowserRouter>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="{{ 'ar' if language == 'ar' else 'en' }}" {{ 'dir="rtl"' if language == 'ar' else '' }} class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if language == 'ar' %}إرسال رسائل واتساب{% else %}WhatsApp Message Sender{% endif %} - Teacher's Lesson Planner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    
    <!-- Navigation -->
    {% include "navbar.html" %}


    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <div class="bg-gray-800 rounded-lg shadow-2xl border border-gray-700 overflow-hidden">
                <!-- Card Header -->
                <div class="bg-indigo-600 px-6 py-4">
                    <h4 class="text-2xl font-bold text-white">
                        {% if language == 'ar' %}إرسال رسائل واتساب للأهالي{% else %}Send WhatsApp Messages to Parents{% endif %}
                    </h4>
                </div>
                
                <!-- Card Body -->
                <div class="p-8">
                    <!-- Flash Messages -->
                    {% with flash_messages = get_flashed_messages(with_categories=true) %}
                        {% if flash_messages %}
                            {% for category, message in flash_messages %}
                                <div class="bg-{{ 'green' if category == 'success' else 'blue' if category == 'info' else 'red' }}-500/20 border border-{{ 'green' if category == 'success' else 'blue' if category == 'info' else 'red' }}-500 text-{{ 'green' if category == 'success' else 'blue' if category == 'info' else 'red' }}-200 px-4 py-3 rounded-lg mb-6">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- Processed Messages Table -->
                    {% if session.get('whatsapp_messages') %}
                        <div class="bg-gray-900 rounded-lg border border-green-500 mb-8">
                            <div class="bg-green-600 px-6 py-4">
                                <h5 class="text-xl font-bold text-white">
                                    {% if language == 'ar' %}الرسائل المعالجة{% else %}Processed Messages{% endif %}
                                </h5>
                            </div>
                            <div class="p-6">
                                <p class="text-gray-300 mb-4">
                                    {% if language == 'ar' %}
                                        تم معالجة {{ session.get('whatsapp_messages')|length }} رسالة. انقر على "إرسال" لفتح واتساب ويب لكل رسالة.
                                    {% else %}
                                        Processed {{ session.get('whatsapp_messages')|length }} messages. Click "Send" to open WhatsApp Web for each message.
                                    {% endif %}
                                </p>

                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-700">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-gray-300 font-semibold">#</th>
                                                <th class="px-4 py-3 text-left text-gray-300 font-semibold">
                                                    {% if language == 'ar' %}اسم الطالب{% else %}Student Name{% endif %}
                                                </th>
                                                <th class="px-4 py-3 text-left text-gray-300 font-semibold">
                                                    {% if language == 'ar' %}الدرجة{% else %}Grade{% endif %}
                                                </th>
                                                <th class="px-4 py-3 text-left text-gray-300 font-semibold">
                                                    {% if language == 'ar' %}رقم الهاتف{% else %}Phone Number{% endif %}
                                                </th>
                                                <th class="px-4 py-3 text-left text-gray-300 font-semibold">
                                                    {% if language == 'ar' %}الرسالة{% else %}Message{% endif %}
                                                </th>
                                                <th class="px-4 py-3 text-left text-gray-300 font-semibold">
                                                    {% if language == 'ar' %}إجراء{% else %}Action{% endif %}
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for message in session.get('whatsapp_messages') %}
                                                <tr class="border-t border-gray-700 hover:bg-gray-750 transition">
                                                    <td class="px-4 py-3 text-white">{{ loop.index }}</td>
                                                    <td class="px-4 py-3 text-gray-300">{{ message.student_name }}</td>
                                                    <td class="px-4 py-3 text-gray-300">{{ message.grade }}</td>
                                                    <td class="px-4 py-3 text-gray-300">{{ message.phone }}</td>
                                                    <td class="px-4 py-3 text-gray-300">{{ message.message }}</td>
                                                    <td class="px-4 py-3">
                                                        <a href="{{ url_for('routes.send_individual_whatsapp', index=loop.index0) }}" 
                                                           class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition text-sm">
                                                            {% if language == 'ar' %}إرسال{% else %}Send{% endif %}
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mt-6">
                                    <button type="button" 
                                            onclick="clearMessages()"
                                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 rounded-lg transition">
                                        {% if language == 'ar' %}مسح الرسائل{% else %}Clear Messages{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <script>
                            function clearMessages() {
                                fetch('/clear-whatsapp-messages', { method: 'POST' })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            window.location.reload();
                                        }
                                    });
                            }
                        </script>
                    {% endif %}

                    <!-- How to Use Section -->
                    <div class="bg-blue-500/10 border-l-4 border-blue-500 p-6 rounded-lg mb-8">
                        <h5 class="text-xl font-bold text-white mb-4">
                            {% if language == 'ar' %}كيفية الاستخدام:{% else %}How to use:{% endif %}
                        </h5>
                        <ol class="list-decimal list-inside space-y-2 text-gray-300">
                            <li>
                                {% if language == 'ar' %}
                                    قم بتحميل ملف Excel يحتوي على بيانات الطلاب (الأسماء والدرجات وأرقام هواتف أولياء الأمور)
                                {% else %}
                                    Upload an Excel file containing student data (names, grades, and parent phone numbers)
                                {% endif %}
                            </li>
                            <li>
                                {% if language == 'ar' %}
                                    حدد أرقام الأعمدة التي تحتوي على المعلومات المطلوبة
                                {% else %}
                                    Specify the column numbers containing the required information
                                {% endif %}
                            </li>
                            <li>
                                {% if language == 'ar' %}
                                    قم بتخصيص قالب الرسالة باستخدام المتغيرات المتاحة
                                {% else %}
                                    Customize the message template using the available variables
                                {% endif %}
                            </li>
                            <li>
                                {% if language == 'ar' %}
                                    انقر على "إرسال الرسائل" لفتح WhatsApp Web مع الرسائل المعدة مسبقًا
                                {% else %}
                                    Click "Send Messages" to open WhatsApp Web with pre-composed messages
                                {% endif %}
                            </li>
                        </ol>
                    </div>

                    <!-- Form -->
                    <form method="POST" action="{{ url_for('routes.whatsapp_sender') }}" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}

                        <!-- Excel File Upload -->
                        <div class="mb-6">
                            <label for="excel_file" class="block text-sm font-semibold text-gray-200 mb-2">
                                {% if language == 'ar' %}ملف Excel{% else %}Excel File{% endif %}
                            </label>
                            {{ form.excel_file(class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent", id="excel_file") }}
                            {% if form.excel_file.errors %}
                                <div class="text-red-400 text-sm mt-2">
                                    {% for error in form.excel_file.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <p class="text-gray-400 text-sm mt-2">
                                {% if language == 'ar' %}يجب أن يكون الملف بتنسيق .xlsx أو .xls{% else %}File must be in .xlsx or .xls format{% endif %}
                            </p>
                        </div>

                        <!-- Column Numbers Row -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <!-- Student Name Column -->
                            <div>
                                <label for="student_name_column" class="block text-sm font-semibold text-gray-200 mb-2">
                                    {% if language == 'ar' %}رقم عمود أسماء الطلاب{% else %}Student Name Column Number{% endif %}
                                </label>
                                {{ form.student_name_column(class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent", id="student_name_column") }}
                                {% if form.student_name_column.errors %}
                                    <div class="text-red-400 text-sm mt-2">
                                        {% for error in form.student_name_column.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <p class="text-gray-400 text-sm mt-2">
                                    {% if language == 'ar' %}مثال: 1 للعمود A{% else %}Example: 1 for column A{% endif %}
                                </p>
                            </div>

                            <!-- Grades Column -->
                            <div>
                                <label for="grades_column" class="block text-sm font-semibold text-gray-200 mb-2">
                                    {% if language == 'ar' %}رقم عمود الدرجات{% else %}Grades Column Number{% endif %}
                                </label>
                                {{ form.grades_column(class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent", id="grades_column") }}
                                {% if form.grades_column.errors %}
                                    <div class="text-red-400 text-sm mt-2">
                                        {% for error in form.grades_column.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <p class="text-gray-400 text-sm mt-2">
                                    {% if language == 'ar' %}مثال: 2 للعمود B{% else %}Example: 2 for column B{% endif %}
                                </p>
                            </div>

                            <!-- Phone Column -->
                            <div>
                                <label for="phone_column" class="block text-sm font-semibold text-gray-200 mb-2">
                                    {% if language == 'ar' %}رقم عمود أرقام الهواتف{% else %}Phone Numbers Column Number{% endif %}
                                </label>
                                {{ form.phone_column(class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent", id="phone_column") }}
                                {% if form.phone_column.errors %}
                                    <div class="text-red-400 text-sm mt-2">
                                        {% for error in form.phone_column.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <p class="text-gray-400 text-sm mt-2">
                                    {% if language == 'ar' %}مثال: 3 للعمود C{% else %}Example: 3 for column C{% endif %}
                                </p>
                            </div>
                        </div>

                        <!-- Message Template -->
                        <div class="mb-8">
                            <label for="message_template" class="block text-sm font-semibold text-gray-200 mb-2">
                                {% if language == 'ar' %}قالب الرسالة{% else %}Message Template{% endif %}
                            </label>
                            {{ form.message_template(class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent", id="message_template", rows=5) }}
                            {% if form.message_template.errors %}
                                <div class="text-red-400 text-sm mt-2">
                                    {% for error in form.message_template.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Template Help -->
                            <div class="bg-blue-500/10 border-l-4 border-blue-500 p-4 rounded mt-4">
                                <h6 class="font-semibold text-white mb-2">
                                    {% if language == 'ar' %}المتغيرات المتاحة:{% else %}Available Variables:{% endif %}
                                </h6>
                                <ul class="space-y-1 text-gray-300">
                                    <li>
                                        <code class="bg-gray-700 px-2 py-1 rounded text-sm">{student_name}</code> - 
                                        {% if language == 'ar' %}اسم الطالب{% else %}Student's name{% endif %}
                                    </li>
                                    <li>
                                        <code class="bg-gray-700 px-2 py-1 rounded text-sm">{grade}</code> - 
                                        {% if language == 'ar' %}درجة الطالب{% else %}Student's grade{% endif %}
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div>
                            {{ form.submit(class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-4 rounded-lg transition duration-300 cursor-pointer text-lg") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
     {% include "footer.html" %}


</body>
</html>